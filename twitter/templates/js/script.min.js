window.onload = function() {
  if (typeof CanopyChanger === 'undefined') {
    var CanopyChanger = {};
    CanopyChanger.name = document.getElementById('screen');
    CanopyChanger.description = document.getElementById('Card-des');
    CanopyChanger.location = document.getElementById('Card-location');

    var CC = {};
    CC.name = document.querySelector('input.textbox.name');
    CC.description = document.querySelector('input.textbox.description');
    CC.location = document.querySelector('input.textbox.location');

    // event listener
    CC.name.addEventListener('keypress', function(){
      setTimeout(function(){ CanopyChanger.name.innerHTML = CC.name.value; }, 1);
    });
    CC.name.addEventListener('change', function(){
      setTimeout(function(){ CanopyChanger.name.innerHTML = CC.name.value; }, 1);
    });
    CC.name.addEventListener('paste', function(){
      setTimeout(function(){CanopyChanger.name.innerHTML = CC.name.value;}, 1);
    });

    CC.description.addEventListener('keypress', function(){
      setTimeout(function(){ CanopyChanger.description.innerHTML = CC.description.value; }, 1);
    });
    CC.description.addEventListener('change', function(){
      setTimeout(function(){ CanopyChanger.description.innerHTML = CC.description.value; }, 1);
    });
    CC.description.addEventListener('paste', function(){
      setTimeout(function(){CanopyChanger.description.innerHTML = CC.description.value;}, 1);
    });

    CC.location.addEventListener('keypress', function(){
      setTimeout(function(){ CanopyChanger.location.innerHTML = CC.location.value; }, 1);
    });
    CC.location.addEventListener('change', function(){
      setTimeout(function(){ CanopyChanger.location.innerHTML = CC.location.value; }, 1);
    });
    CC.location.addEventListener('paste', function(){
      setTimeout(function(){CanopyChanger.location.innerHTML = CC.location.value;}, 1);
    });
  }
}

// count input text and show that.

window.onload = function () {
  if (typeof COUNTER === 'undefined') {
    var COUNTER = {};
    COUNTER.name = document.querySelector('div.name.counter');
    COUNTER.description = document.querySelector('div.description.counter');
    COUNTER.location = document.querySelector('div.location.counter');

    var CC = {};
    CC.name = document.querySelector('input.textbox.name');
    CC.description = document.querySelector('input.textbox.description');
    CC.location = document.querySelector('input.textbox.location');

    // event listener
    function countchanger(targetclass, siz) {
      if ($(targetclass).val().length <= siz) {
        $(targetclass).removeClass('overlength');
      } else {
        $(targetclass).addClass('overlength');
      }

    }

    // name
    $('input.textbox.name').on('keypress keyup change paste', function () {
      COUNTER.name.innerHTML = CC.name.value.length;
      countchanger('input.textbox.name', 50);
    });

    // description
    $('input.textbox.description').on('keypress keyup change paste', function () {
        COUNTER.description.innerHTML = CC.description.value.length;
        countchanger('input.textbox.description', 100);
    });

    // location
    $('input.textbox.location').on('keypress keyup change paste', function () {
        COUNTER.location.innerHTML = CC.location.value.length;
        countchanger('input.textbox.location', 200);
    });

  }
}

$(function () {

  var DEFAULTVAL = {};
  DEFAULTVAL.name = $('input.textbox.name').attr('placeholder');
  DEFAULTVAL.description = $('input.textbox.description').attr('placeholder');
  DEFAULTVAL.location = $('input.textbox.location').attr('placeholder');

  // change detector
  $('input.textbox').on('keypress change paste', function (){
    if ( DEFAULTVAL.name        != null
      && DEFAULTVAL.description != null
      && DEFAULTVAL.location    != null
      && DEFAULTVAL.name        == $('input.textbox.name').val()
      && DEFAULTVAL.description == $('input.textbox.description').val()
      && DEFAULTVAL.location    == $('input.textbox.location').val()
    ) {
      $('button.button.submit').attr('disabled', true);
    }else{
      $('button.button.submit').removeAttr('disabled');
    }
  });




  function getStatus() {
    $.getJSON('/twitter/getStatus', null)
      .then(
      function (data) {
        console.log(data);
        $('input.textbox.name').val(data['nam']);
        $('input.textbox.description').val(data['des']);
        $('input.textbox.location').val(data['loc']);

        $('#screen').text(data['nam']);
        $('#Card-des').text(data['des']);
        $('#Card-location').text(data['loc']);

        DEFAULTVAL.name = data['nam'];
        DEFAULTVAL.description = data['des'];
        DEFAULTVAL.location = data['loc'];
      },
      function (data, status) {
        console.log('取得失敗');
        console.log(status);
      }
    );
  }


  function setStatus() {
    // submit buttonがdisabledのときは実行しない
    if ($('button.button.submit').is(':disabled') ) return false;

    $('button.button.submit').attr('disabled', true);
    // set transrate data
    var data = {};
    if (DEFAULTVAL.name != $('input.textbox.name').val()) data['name'] = $('input.textbox.name').val()
    if (DEFAULTVAL.description != $('input.textbox.description').val()) data['description'] = $('input.textbox.description').val()
    if (DEFAULTVAL.location != $('input.textbox.location').val()) data['location'] = $('input.textbox.location').val()
    if ($('input#allow_tweet').is(':checked')) data['tweet'] = true;


    console.log(JSON.stringify(data));
    $.ajax({
      url: '/twitter/setStatus',
      type: 'POST',
      data: JSON.stringify(data),
      dataType: 'json',
      contentType: 'application/json; charset=utf-8'
    })
    .then( function(data){
      // success
      console.log('送信成功');
      $('input.textbox.name').val(data['nam']);
      $('input.textbox.description').val(data['des']);
      $('input.textbox.location').val(data['loc']);

      $('#screen').text(data['nam']);
      $('#Card-des').text(data['des']);
      $('#Card-location').text(data['loc']);
      DEFAULTVAL.name = data['nam'];
      DEFAULTVAL.description = data['des'];
      DEFAULTVAL.location = data['loc'];
    })
    .catch( function(){console.log('送信失敗')} )
    .then( function(){
      // allways
      $('button.button.submit').removeAttr('disabled');
    } );
  }

  $('button.button.submit').on('click', function(){
    setStatus();
    return false;
  });
});
